<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>幸運賽模擬器</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    h1 { margin-top: 30px; font-size: 40px; }
    .controls { margin: 20px; }
    select, button { font-size: 18px; padding: 6px 12px; margin: 0 10px; }
    .table {
      background: #b55a00;
      margin: 0 auto;
      width: 800px;
      height: 460px;
      border-radius: 50% / 35%;
      position: relative;
    }
    .player {
      position: absolute;
      width: 140px;
      transform: translate(-50%, -50%);
      font-weight: bold;
      color: white;
    }
    .cards { margin: 4px 0; }
    .card {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 6px;
      font-family: monospace;
      margin: 2px;
      font-size: 18px;
      color: white;
    }
    .♠ { background: black; }
    .♣ { background: green; }
    .♥ { background: red; }
    .♦ { background: blue; }
    .highlight {
      box-shadow: 0 0 0 4px gold, 0 0 8px gold;
      border: 2px solid #fff;
    }
    .winrate {
      font-size: 14px;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <h1>幸運賽模擬器</h1>
  <div class="controls">
    玩家人數：
    <select id="playerCount">
      <option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
    </select>
    <button onclick="deal()">重新發牌</button>
  </div>
  <div class="table" id="table"></div>

  <script>
    const SUITS = ['♠', '♥', '♦', '♣'];
    const RANKS = ['A','K','Q','J','10','9','8','7','6','5','4','3','2'];
    let players = [];

    function shuffleDeck() {
      let deck = [];
      for (let s of SUITS)
        for (let r of RANKS)
          deck.push(r + s);
      for (let i = deck.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }

    function deal() {
      const n = parseInt(document.getElementById("playerCount").value);
      let deck = shuffleDeck();
      players = [];
      for (let i = 0; i < n; i++)
        players.push(deck.splice(0, 3));
      renderPlayers();
      fetchBestCombos();
    }

    function renderPlayers(results=[]) {
      const table = document.getElementById("table");
      table.innerHTML = '';
      const angleStep = 360 / players.length;
      players.forEach((cards, i) => {
        const div = document.createElement('div');
        div.className = 'player';
        const angle = angleStep * i - 90;
        const radiusX = 340, radiusY = 180;
        const x = 400 + radiusX * Math.cos(angle * Math.PI / 180);
        const y = 230 + radiusY * Math.sin(angle * Math.PI / 180);
        div.style.left = x + 'px';
        div.style.top = y + 'px';

        div.innerHTML = `
          <div>Player ${i + 1}</div>
          <div class="cards">${cards.map(c => `<span class="card ${c.slice(-1)}" data-card="${c}">${c}</span>`).join('')}</div>
          <div class="winrate" id="win-${i}">${results[i] ? `勝率：${results[i].win_rate}%` : ''}</div>`;
        table.appendChild(div);
      });
    }

    function fetchBestCombos() {
      fetch('/bestcombo', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ players })
      })
      .then(res => res.json())
      .then(data => {
        renderPlayers(data);
        data.forEach((r, i) => {
          const playerCards = document.querySelectorAll(`.player:nth-child(${i + 1}) .card`);
          playerCards.forEach(el => {
            if (r.best_cards.includes(el.dataset.card)) el.classList.add('highlight');
          });
        });
      });
    }

    window.onload = deal;
  </script>
</body>
</html>
